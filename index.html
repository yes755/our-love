<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Love Archive ❤️</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p-pink: #ffb7b2; --p-peach: #ffdac1; --text: #7d5a5a; --bg: #fff9f5; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* 导航栏 */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .nav-box { display: flex; gap: 8px; background: #f0f0f0; padding: 4px; border-radius: 20px; }
        .nav-item { padding: 6px 14px; border-radius: 15px; cursor: pointer; border: none; background: none; color: #888; font-size: 14px; transition: 0.3s; }
        .nav-item.active { background: white; color: var(--p-pink); font-weight: bold; }

        /* 内容区 */
        main { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page { display: none; max-width: 500px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        /* 纪念日样式 */
        .card { background: white; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 10px 20px rgba(255,183,178,0.2); margin-top: 20px; }
        #days-num { font-size: 3.5em; font-weight: bold; color: var(--p-pink); display: block; }

        /* 实时聊天样式 */
        #chatBox { height: 60vh; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 10px; }
        .bubble { padding: 10px 16px; border-radius: 18px; max-width: 80%; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .bubble.mine { align-self: flex-end; background: var(--p-pink); color: white; border-bottom-right-radius: 2px; }
        .bubble.other { align-self: flex-start; background: white; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* 输入框固定在底部 */
        .input-area { padding: 15px 20px; background: white; border-top: 1px solid #eee; display: none; gap: 10px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .input-area.show { display: flex; }
        input { flex: 1; border: 1px solid #ddd; padding: 12px 18px; border-radius: 25px; outline: none; font-size: 16px; }
        .send-btn { background: var(--p-pink); color: white; border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">Forever ❤️</div>
    <div class="nav-box">
        <button class="nav-item active" onclick="showPage('home')">日常</button>
        <button class="nav-item" onclick="showPage('chat')">密语</button>
    </div>
</header>

<main>
    <div id="home" class="page active">
        <div class="card">
            <span id="days-num">0</span>
            <div style="letter-spacing: 2px; opacity: 0.8;">DAYS TOGETHER</div>
            <p style="margin-top: 20px; font-size: 0.9em; color: #999;">
                今天是 2026年2月14日<br>情人节快乐，我的宝贝
            </p>
        </div>
    </div>

    <div id="chat" class="page">
        <div id="chatBox"></div>
    </div>
</main>

<div id="inputArea" class="input-area">
    <input type="text" id="msgInput" placeholder="写下想说的话..." onkeypress="if(event.keyCode==13) doSend()">
    <button class="send-btn" onclick="doSend()">发送</button>
</div>

<script>
    // ======= 填入你的 Supabase 配置 =======
    const SB_URL = "https://hnqovklqpdmxancxvmti.supabase.co"; 
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhucW92a2xxcGRteGFuY3h2bXRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5ODcwNzIsImV4cCI6MjA4NjU2MzA3Mn0.TiRChN-T3amFLdwPozGrlSiA8ncTAfU5rxe81VTgW8I";
    // =====================================

    const _sb = supabase.createClient(SB_URL, SB_KEY);
    const role = window.location.hash === '#partner' ? 'partner' : 'me';

    // 初始化
    window.onload = () => {
        // 计算天数
        const startDate = new Date('2024-05-20'); // 改成你们在一起的日期
        const today = new Date();
        document.getElementById('days-num').innerText = Math.floor((today - startDate) / 86400000);
        
        loadHistory();
        initRealtime();
    };

    // 页面切换
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
        
        // 只有聊天页显示输入框
        document.getElementById('inputArea').className = (id === 'chat') ? 'input-area show' : 'input-area';
    }

    // 加载历史
    async function loadHistory() {
        const { data } = await _sb.from('messages').select('*').order('created_at', { ascending: true });
        if (data) data.forEach(m => append(m.text, m.user === role ? 'mine' : 'other'));
    }

    // 实时监听
    function initRealtime() {
        _sb.channel('chat-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
            if (p.new.user !== role) append(p.new.text, 'other');
        }).subscribe();
    }

    // 发送消息
    async function doSend() {
        const ipt = document.getElementById('msgInput');
        const txt = ipt.value.trim();
        if (!txt) return;

        // 瞬间反馈：先画出来
        append(txt, 'mine');
        ipt.value = '';

        const { error } = await _sb.from('messages').insert([{ text: txt, user: role }]);
        if (error) console.error("发送失败:", error);
    }

    function append(txt, type) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = 'bubble ' + type;
        div.innerText = txt;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
</script>

</body>
</html>